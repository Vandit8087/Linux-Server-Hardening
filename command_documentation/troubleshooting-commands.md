# Troubleshooting Commands - Linux Server Hardening

This document provides troubleshooting steps for common issues encountered during and after hardening implementation.

## SSH Connection Issues

### Problem: Cannot connect to SSH after hardening

#### Diagnosis Commands
```bash
# Check SSH service status
systemctl status sshd
journalctl -u sshd -f

# Verify SSH configuration
sudo sshd -t
sudo sshd -T | grep -E "(port|permitrootlogin|passwordauthentication)"

# Check if SSH is listening on correct port
sudo netstat -tlnp | grep sshd
sudo ss -tlnp | grep sshd

# Test network connectivity to SSH port
telnet localhost 2022
nc -zv localhost 2022
```

#### Common Solutions
```bash
# Restart SSH service
sudo systemctl restart sshd

# Check SSH configuration syntax
sudo sshd -t

# Restore backup configuration if needed
sudo cp /backup/ssh/sshd_config.backup /etc/ssh/sshd_config
sudo systemctl restart sshd

# Verify SSH keys permissions
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
chmod 700 ~/.ssh/
chmod 600 ~/.ssh/authorized_keys
```

### Problem: SSH key authentication not working

#### Diagnosis Commands
```bash
# Check SSH key file permissions
ls -la ~/.ssh/
ls -la ~/.ssh/authorized_keys

# Verify key format
ssh-keygen -l -f ~/.ssh/id_rsa.pub

# Test with verbose output
ssh -vvv -p 2022 username@server

# Check server-side authentication logs
sudo tail -f /var/log/auth.log | grep ssh
```

#### Solutions
```bash
# Fix key permissions
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub

# Regenerate SSH keys if corrupted
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_new
ssh-copy-id -i ~/.ssh/id_rsa_new.pub -p 2022 username@server

# Check SELinux context (if applicable)
restorecon -R ~/.ssh/
```

## Firewall (UFW) Issues

### Problem: UFW blocking legitimate traffic

#### Diagnosis Commands
```bash
# Check UFW status and rules
sudo ufw status verbose
sudo ufw status numbered

# View UFW logs
sudo tail -f /var/log/ufw.log

# Check iptables rules generated by UFW
sudo iptables -L -n
sudo iptables -L INPUT -n --line-numbers
```

#### Solutions
```bash
# Allow specific IP temporarily
sudo ufw allow from TRUSTED_IP

# Allow specific service
sudo ufw allow SERVICE_NAME

# Insert rule at specific position
sudo ufw insert 1 allow from TRUSTED_IP to any port 2022

# Temporarily disable UFW for testing
sudo ufw disable
# Test connectivity, then re-enable
sudo ufw enable
```

### Problem: UFW rules not taking effect

#### Diagnosis and Solutions
```bash
# Reload UFW
sudo ufw reload

# Check UFW status
sudo ufw --dry-run allow 2022

# Reset and reconfigure UFW
sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 2022/tcp
sudo ufw enable

# Check for conflicting iptables rules
sudo iptables -L -n | grep -E "(DROP|REJECT|ACCEPT)"
```

## fail2ban Issues

### Problem: fail2ban not starting or working

#### Diagnosis Commands
```bash
# Check fail2ban service status
systemctl status fail2ban
journalctl -u fail2ban -f

# Test fail2ban configuration
sudo fail2ban-client -t

# Check jail status
sudo fail2ban-client status
sudo fail2ban-client status sshd

# Check log file accessibility
sudo -u fail2ban test -r /var/log/auth.log
ls -la /var/log/auth.log
```

#### Solutions
```bash
# Fix log file permissions
sudo chmod 644 /var/log/auth.log
sudo chown root:adm /var/log/auth.log

# Restart fail2ban with clean state
sudo systemctl stop fail2ban
sudo rm -f /var/run/fail2ban/fail2ban.sock
sudo systemctl start fail2ban

# Check configuration syntax
sudo fail2ban-client -t

# Manually reload configuration
sudo fail2ban-client reload

# Check if jail is using correct log path
sudo fail2ban-client get sshd logpath
```

### Problem: fail2ban not detecting attacks

#### Diagnosis Commands
```bash
# Test filter manually
sudo fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf

# Check findtime and maxretry settings
sudo fail2ban-client get sshd findtime
sudo fail2ban-client get sshd maxretry

# Monitor real-time log processing
sudo tail -f /var/log/fail2ban.log

# Test with manual log entries
logger -p auth.info "Failed password for testuser from 192.168.1.100 port 12345 ssh2"
```

#### Solutions
```bash
# Adjust detection sensitivity
sudo fail2ban-client set sshd maxretry 2
sudo fail2ban-client set sshd findtime 300

# Update filter patterns
sudo cp /etc/fail2ban/filter.d/sshd.conf /etc/fail2ban/filter.d/sshd.conf.backup
# Edit filter file to match your log format

# Force jail reload
sudo fail2ban-client reload sshd
```

## Network Monitoring Issues

### Problem: tcpdump not capturing expected traffic

#### Diagnosis Commands
```bash
# Check network interfaces
ip link show
ifconfig -a

# Verify interface is up and has traffic
ip -s link show eth0

# Check if running with correct permissions
ps aux | grep tcpdump

# Test basic capture
sudo tcpdump -i eth0 -c 10
```

#### Solutions
```bash
# Use correct interface name
ip route | grep default
# Use the interface from default route

# Check for multiple interfaces
sudo tcpdump -i any port 2022

# Verify network activity
ping -c 5 server-ip

# Check capture file permissions
ls -la /path/to/capture/files/
sudo chown user:user capture_file.pcap
```

### Problem: Network monitoring script not running

#### Diagnosis and Solutions
```bash
# Check script permissions
ls -la scripts/network-monitor.sh
chmod +x scripts/network-monitor.sh

# Run script manually with debug
bash -x scripts/network-monitor.sh

# Check for running processes
ps aux | grep network-monitor
pgrep -f network-monitor

# Kill stuck processes
pkill -f network-monitor
```

## Performance Issues

### Problem: System slow after hardening

#### Diagnosis Commands
```bash
# Check system load
uptime
top -bn1
htop

# Check memory usage
free -h
ps aux --sort=-%mem | head -10

# Check disk I/O
iostat -x 1 5
iotop -o

# Check network usage
iftop -t -s 10
nethogs
```

#### Solutions
```bash
# Optimize fail2ban performance
# Edit /etc/fail2ban/jail.local
[DEFAULT]
backend = systemd  # Use systemd backend instead of polling

# Reduce UFW logging if excessive
sudo ufw logging off
# or
sudo ufw logging low

# Optimize SSH connection pooling
# Add to ~/.ssh/config
Host *
    ControlMaster auto
    ControlPath ~/.ssh/control:%h:%p:%r
    ControlPersist 10m
```

## Log File Issues

### Problem: Log files growing too large

#### Solutions
```bash
# Configure log rotation
sudo nano /etc/logrotate.d/custom-security

/var/log/auth.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    create 0640 root adm
}

/var/log/fail2ban.log {
    weekly
    rotate 12
    compress
    delaycompress
    missingok
    create 0640 root adm
}

# Force log rotation
sudo logrotate -f /etc/logrotate.conf

# Clean old log files
sudo find /var/log -name "*.gz" -mtime +90 -delete
```

### Problem: Cannot access log files

#### Solutions
```bash
# Fix log file permissions
sudo chmod 644 /var/log/auth.log
sudo chmod 644 /var/log/syslog

# Add user to adm group for log access
sudo usermod -a -G adm $USER
# Logout and login again

# Check rsyslog service
systemctl status rsyslog
sudo systemctl restart rsyslog
```

## Emergency Recovery Procedures

### Complete System Lockout Recovery

#### If you can still access via console/physical access:
```bash
# Stop all security services
sudo systemctl stop fail2ban
sudo systemctl stop ufw

# Restore original SSH configuration
sudo cp /backup/ssh/sshd_config.backup /etc/ssh/sshd_config
sudo systemctl restart sshd

# Disable firewall temporarily
sudo ufw disable

# Test SSH access
ssh -p 22 username@server-ip
```

#### If you have backup access method:
```bash
# Use emergency access account or console
# Restore all configurations from backup
sudo systemctl stop fail2ban ufw

# Reset SSH to defaults
sudo cp /etc/ssh/sshd_config.original /etc/ssh/sshd_config
sudo systemctl restart sshd

# Reset UFW
sudo ufw --force reset
sudo ufw disable
```

### Configuration Rollback Script
```bash
#!/bin/bash
# emergency-rollback.sh

echo "EMERGENCY ROLLBACK - Removing all hardening"
echo "This will restore system to pre-hardening state"

read -p "Continue? (yes/no): " confirm
[[ $confirm != "yes" ]] && exit 1

# Stop services
systemctl stop fail2ban ufw

# Restore SSH
if [[ -f /backup/ssh/sshd_config.backup ]]; then
    cp /backup/ssh/sshd_config.backup /etc/ssh/sshd_config
    systemctl restart sshd
fi

# Reset firewall
ufw --force reset
ufw disable

# Disable services
systemctl disable fail2ban ufw

echo "Rollback completed. SSH should be accessible on port 22"
```

## Debug Mode Operations

### Enable Debug Logging
```bash
# SSH debug mode
sudo nano /etc/ssh/sshd_config
# Set: LogLevel DEBUG
sudo systemctl restart sshd

# fail2ban debug mode
sudo fail2ban-client set loglevel DEBUG

# UFW debug logging
sudo ufw logging full
```

### System Diagnostic Script
```bash
#!/bin/bash
# system-diagnostic.sh

echo "=== System Diagnostic Report ==="
echo "Date: $(date)"
echo

echo "=== Service Status ==="
for service in sshd ufw fail2ban; do
    echo "$service: $(systemctl is-active $service 2>/dev/null || echo 'not found')"
done
echo

echo "=== Network Listening ==="
netstat -tlnp 2>/dev/null || ss -tlnp
echo

echo "=== Recent Auth Events ==="
tail -20 /var/log/auth.log
echo

echo "=== Disk Space ==="
df -h
echo

echo "=== Memory Usage ==="
free -h
echo

echo "=== Load Average ==="
uptime
echo

echo "=== End Diagnostic ==="
```

## Prevention Strategies

### Before Making Changes
```bash
# Always create backup
sudo cp /etc/ssh/sshd_config /backup/ssh/sshd_config.$(date +%Y%m%d_%H%M%S)

# Test in development environment first
# Document all changes
# Have rollback plan ready
```

### Monitoring for Issues
```bash
# Set up monitoring alerts
# Monitor system resources
# Check log files regularly
# Test access methods periodically
```

This troubleshooting guide should help resolve most common issues encountered during Linux server hardening implementation.